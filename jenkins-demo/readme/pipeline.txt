pipeline {  
 agent any  
 environment {  
  dotnet = 'C:\\Program Files\\dotnet\\dotnet.exe'  
 }  
 stages {  
  stage('Checkout') {  
   steps {
       git credentialsId: '0bdf4174-ecec-4258-93d8-f262faf9e67d', url: 'https://github.com/mahedee/code-sample02.git', branch: 'main'
     //checkout([$class: 'GitSCM', branches: [[name: "*/"]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'git@github.com:mahedee/code-sample02.git']]])
       
    //git credentialsId: 'b861bd5c-1ad6-4b02-b097-7206f87fb1be', url: 'https://github.com/mahedee/code-sample02/tree/main/jenkins-demo', branch: 'main'  
   }  
  }  
 stage('Build') {  
   steps {  
    bat 'dotnet build C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\JenkinsPipeline\\jenkins-demo\\HRM\\HRM.sln --configuration Release'  
   }  
  }  
  stage('Test') {  
   steps {  
    bat 'dotnet test %WORKSPACE%\\jenkins-demo\\HRM\\HRM.Test\\HRM.Test.csproj --logger:trx'  
    //bat 'dotnet test C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\JenkinsPipeline\\jenkins-demo\\HRM\\HRM.Test\\HRM.Test.csproj --logger:trx'  
   }  
  }
  
  stage("Release"){
      steps {
      bat 'dotnet build  %WORKSPACE%\\jenkins-demo\\HRM\\HRM.sln /p:PublishProfile=" %WORKSPACE%\\jenkins-demo\\HRM\\HRM.API\\Properties\\PublishProfiles\\JenkinProfile.pubxml" /p:Platform="Any CPU" /p:DeployOnBuild=true /m'
    }
  }
  
  stage('Deploy') {
    steps {
    // Stop IIS
    bat 'net stop "w3svc"'
    
    // Deploy package to IIS
    bat '"C:\\Program Files (x86)\\IIS\\Microsoft Web Deploy V3\\msdeploy.exe" -verb:sync -source:package="%WORKSPACE%\\jenkins-demo\\HRM\\HRM.API\\bin\\Debug\\net6.0\\HRM.API.zip" -dest:auto -setParam:"IIS Web Application Name"="HRM.Web" -skip:objectName=filePath,absolutePath=".\\\\PackageTmp\\\\Web.config$" -enableRule:DoNotDelete -allowUntrusted=true'
    //bat '"C:\\Program Files (x86)\\IIS\\Microsoft Web Deploy V3\\msdeploy.exe" -verb:sync -source:package="%WORKSPACE%\\src\\Asa.Ambs.WebSite\\obj\\Release\\Package\\Asai.Ambs.WebSite.zip" -dest:auto -setParam:"IIS Web Application Name"="HRM.Web" -skip:objectName=filePath,absolutePath=".\\\\PackageTmp\\\\Web.config$" -enableRule:DoNotDelete -allowUntrusted=true'
    //archiveArtifacts artifacts: '/**'
    
    // Start IIS again
    bat 'net start "w3svc"'
    }
 }

 }  
} 